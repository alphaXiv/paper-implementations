Bootstrap: docker
From: nvidia/cuda:12.9.1-cudnn-runtime-ubuntu22.04

%post
    chmod 1777 /tmp
    export DEBIAN_FRONTEND=noninteractive

    # Install minimal system dependencies
    apt-get update && apt-get install -y \
        python3.10 \
        python3-dev \
        git \
        curl \
        && rm -rf /var/lib/apt/lists/*

    # Create python3 symlink
    ln -sf /usr/bin/python3.10 /usr/bin/python3
    ln -sf /usr/bin/python3.10 /usr/bin/python
    
    # Install Node.js (only for codex CLI)
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    apt-get install -y nodejs
    apt-get clean && rm -rf /var/lib/apt/lists/*
    
    # Install uv
    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH="/root/.local/bin:$PATH"
    
    # Install essential packages (including vLLM for evaluation)
    uv pip install --system --no-cache ninja packaging
    uv pip install --system --no-cache vllm==0.11.0 --torch-backend=auto
    
    uv pip install --system --no-cache \
        torch \
        transformers \
        datasets \
        accelerate \
        peft \
        trl \
        tokenizers \
        bitsandbytes \
        scikit-learn \
        certifi \
        inspect-ai
    
    # Install inspect evals (needed for evaluation)
    mkdir -p /opt
    cd /opt
    git clone --depth=1 https://github.com/UKGovernmentBEIS/inspect_evals.git
    cd /opt/inspect_evals
    uv pip install --system --no-cache .
    
    # Only install codex CLI (remove Claude and Gemini if not needed)
    npm install -g @openai/codex
    
    # Clean npm cache
    npm cache clean --force
    
    # Clean pip cache (already using --no-cache, but ensure)
    rm -rf /root/.cache/pip
    # Note: Not cleaning /tmp/* as it can interfere with container build process

%environment
    export PATH="/root/.local/bin:$PATH"
    export NO_PROXY="localhost,127.0.0.1"
    export no_proxy="localhost,127.0.0.1"

%runscript
    exec python3 "$@"

%labels
    Version v1.0-minimal
    Description Optimized Python ML container - uses runtime base, removes unused CLI tools

%help
    Note: Use the --nv flag to enable NVIDIA GPU support when running the container.
    This optimized version uses runtime base image and removes unused CLI tools (Claude, Gemini).

